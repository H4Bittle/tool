{% extends "base.html" %}

{% block title %}Add Vulnerabilities | H4 B.I.T.T.L.E{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">Add Vulnerabilities</h2>

    <div class="mb-3">
        <label for="existingVulnSelect" class="form-label">Add from Existing Templates</label>
        <select id="existingVulnSelect" class="form-select">
            <option value="">-- Select a Template --</option>
        </select>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addFromTemplateBtn">Add Selected Template</button>
    </div>

    <form id="vulnForm" enctype="multipart/form-data">
        <!-- CSRF token for Flask-WTF -->
        <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="app_id" value="{{ app_id }}">
        <div id="vulnGroup">
            <div class="vuln-entry border p-3 mb-3">
                <!-- Vulnerability Fields -->
                <div class="mb-3"><label class="form-label">Vulnerability ID</label>
                    <input type="text" class="form-control" name="vuln_id" required>
                </div>
                <div class="mb-3"><label class="form-label">Title</label>
                    <input type="text" class="form-control" name="title" required>
                </div>
                <div class="mb-3"><label class="form-label">CVSS Score</label>
                    <input type="number" step="0.1" min="0" max="10" class="form-control" name="cvss" required>
                </div>
                <div class="mb-3"><label class="form-label">CVSS Vector</label>
                    <input type="text" class="form-control" name="cvss_vector">
                </div>
                <div class="mb-3"><label class="form-label">Severity</label>
                    <select class="form-select" name="severity" required>
                        <option value="">Select</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                        <option value="Info">Info</option>
                    </select>
                </div>
                <div class="mb-3"><label class="form-label">Affected URL</label>
                    <input type="url" class="form-control" name="url">
                </div>
                <div class="mb-3"><label class="form-label">Summary</label>
                    <textarea class="form-control" name="summary" rows="2" required></textarea>
                </div>
                <div class="mb-3"><label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3" required></textarea>
                </div>
                <div class="mb-3"><label class="form-label">Business Impact</label>
                    <textarea class="form-control" name="impact" rows="2" required></textarea>
                </div>
                <div class="mb-3"><label class="form-label">Recommendation</label>
                    <textarea class="form-control" name="recommendation" rows="2" required></textarea>
                </div>
                <div class="mb-3"><label class="form-label">CVE / CWE</label>
                    <input type="text" class="form-control" name="cwe">
                </div>
                <div class="mb-3"><label class="form-label">References</label>
                    <textarea class="form-control" name="reference" rows="2"></textarea>
                </div>

                <!-- Steps -->
                <div class="mb-3">
                    <h6>Steps to Reproduce (Max 12)</h6>
                    <div class="stepsContainer"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary addStep">+ Add Step</button>
                </div>

                <button type="button" class="btn btn-outline-danger remove-vuln">-</button>
            </div>
        </div>

        <button type="button" class="btn btn-outline-secondary mb-3" id="addVulnBtn">+ Add Another Vulnerability</button>
        <br>
        <button type="submit" class="btn btn-primary">Submit Vulnerabilities</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const vulnGroup = document.getElementById("vulnGroup");

    document.getElementById("addVulnBtn").addEventListener("click", function () {
        const clone = vulnGroup.firstElementChild.cloneNode(true);
        clone.querySelectorAll("input, textarea, select").forEach(el => el.value = "");
        clone.querySelector(".stepsContainer").innerHTML = "";
        vulnGroup.appendChild(clone);
    });

    vulnGroup.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-vuln")) {
            if (vulnGroup.children.length > 1) {
                e.target.closest(".vuln-entry").remove();
            }
        }
        if (e.target.classList.contains("addStep")) {
            const stepsDiv = e.target.previousElementSibling;
            const stepCount = stepsDiv.children.length;
            if (stepCount >= 12) return alert("Maximum 12 steps allowed.");
            const wrapper = document.createElement("div");
            wrapper.className = "mb-2";
            wrapper.innerHTML = `
                <label class="form-label">Step ${stepCount + 1}</label>
                <textarea class="form-control mb-2" name="step_desc" rows="2" placeholder="Step description"></textarea>
                <input type="file" class="form-control" name="step_img" accept="image/*">
            `;
            stepsDiv.appendChild(wrapper);
        }
    });

   document.getElementById("addFromTemplateBtn").addEventListener("click", () => {
    const selected = document.getElementById("existingVulnSelect").value;
    if (!selected) return;

    const data = JSON.parse(selected);

    const clone = vulnGroup.firstElementChild.cloneNode(true);
    clone.querySelectorAll("input, textarea, select").forEach(el => el.value = "");
    const stepsDiv = clone.querySelector(".stepsContainer");
    stepsDiv.innerHTML = "";

    if (clone.querySelector("input[name='vuln_id']")) clone.querySelector("input[name='vuln_id']").value = data.id || "";
    if (clone.querySelector("input[name='title']")) clone.querySelector("input[name='title']").value = data.title || "";
    if (clone.querySelector("input[name='cvss']")) clone.querySelector("input[name='cvss']").value = (data.cvss ?? "").toString();
    if (clone.querySelector("input[name='cvss_vector']")) clone.querySelector("input[name='cvss_vector']").value = data.cvss_vector || "";
    if (clone.querySelector("select[name='severity']")) clone.querySelector("select[name='severity']").value = data.severity || "";
    if (clone.querySelector("input[name='url']")) clone.querySelector("input[name='url']").value = data.url || "";
    if (clone.querySelector("textarea[name='summary']")) clone.querySelector("textarea[name='summary']").value = data.summary || "";
    if (clone.querySelector("textarea[name='description']")) clone.querySelector("textarea[name='description']").value = data.description || "";
    if (clone.querySelector("textarea[name='impact']")) clone.querySelector("textarea[name='impact']").value = data.impact || "";
    if (clone.querySelector("textarea[name='recommendation']")) clone.querySelector("textarea[name='recommendation']").value = data.recommendation || "";
    if (clone.querySelector("input[name='cwe']")) clone.querySelector("input[name='cwe']").value = data.cwe || "";
    if (clone.querySelector("textarea[name='reference']")) clone.querySelector("textarea[name='reference']").value = data.reference || "";

    const steps = Array.isArray(data.steps) ? data.steps.slice(0, 12) : [];
    steps.forEach((s, i) => {
        const wrap = document.createElement("div");
        wrap.className = "mb-2";
        wrap.innerHTML = `
            <label class="form-label">Step ${i + 1}</label>
            <textarea class="form-control mb-2" name="step_desc" rows="2">${s?.description || ""}</textarea>
            <input type="file" class="form-control" name="step_img" accept="image/*">
        `;
        stepsDiv.appendChild(wrap);
    });

    vulnGroup.appendChild(clone);
});


    fetch("/vulnerability_templates")
        .then(res => res.json())
        .then(templates => {
            const select = document.getElementById("existingVulnSelect");
            templates.forEach(tpl => {
                const opt = document.createElement("option");
                opt.value = JSON.stringify(tpl);
                opt.textContent = tpl.title;
                select.appendChild(opt);
            });
        });

    document.getElementById("vulnForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const appId = document.getElementById("app_id").value;
        const formData = new FormData();
        formData.append("application_id", appId);

        // Add CSRF token to FormData!
        const csrfToken = document.getElementById("csrf_token").value;
        formData.append("csrf_token", csrfToken);

        const allEntries = [];

        vulnGroup.querySelectorAll(".vuln-entry").forEach((entry, idx) => {
            const vuln = {
                id: entry.querySelector("input[name='vuln_id']").value,
                title: entry.querySelector("input[name='title']").value,
                cvss: entry.querySelector("input[name='cvss']").value,
                cvss_vector: entry.querySelector("input[name='cvss_vector']").value,
                severity: entry.querySelector("select[name='severity']").value,
                url: entry.querySelector("input[name='url']").value,
                summary: entry.querySelector("textarea[name='summary']").value,
                description: entry.querySelector("textarea[name='description']").value,
                impact: entry.querySelector("textarea[name='impact']").value,
                recommendation: entry.querySelector("textarea[name='recommendation']").value,
                cwe: entry.querySelector("input[name='cwe']").value,
                reference: entry.querySelector("textarea[name='reference']").value,
                steps: []
            };

            const stepDescs = entry.querySelectorAll("textarea[name='step_desc']");
            const stepImgs = entry.querySelectorAll("input[name='step_img']");

            stepDescs.forEach((descEl, i) => {
                const imgFile = stepImgs[i]?.files?.[0];
                const screenshotName = imgFile ? `vuln${idx}_step${i}_${imgFile.name}` : "";
                if (imgFile) {
                    formData.append(screenshotName, imgFile);
                }
                vuln.steps.push({
                    description: descEl.value,
                    screenshot: screenshotName
                });
            });

            allEntries.push(vuln);
        });

        formData.append("vulnerabilities", JSON.stringify(allEntries));

        fetch("/add_vulnerability", {
            method: "POST",
            body: formData
        })
        .then(async res => {
            if (!res.ok) {
                const raw = await res.text();
                console.error("Error response:", raw);
                alert("Server error occurred.");
                return;
            }
            return res.json();
        })
        .then(data => {
            if (data?.success) {
                alert("Vulnerabilities added successfully!");
                window.location.href = "/dashboard";
            } else {
                alert("Failed to save vulnerabilities.");
            }
        })
        .catch(err => {
            console.error("Error submitting form:", err);
            alert("Submission error");
        });
    });
});
</script>
{% endblock %}
